---
title: "Time series metrics"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Time series metrics}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  markdown: 
    wrap: 72
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  eval = TRUE,
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(ggplot2)
library(dplyr)
library(Buccaneer)
```

# Background

In this article we will show how to calculate different metrics of
interspecific competition (or sometimes coexistence metrics) at
different taxonomic levels in deep time using {`Buccaneer`} R package.

For all metrics we will use data from [Graciotti et al.
(2025)](https://academic.oup.com/evolut/article-abstract/79/9/1835/8140865?redirectedFrom=fulltext).
This comprises fossil record of North American canids, a group that has
been well caracterized ecologically and regarding fossil record. The
data is part of the {`Buccaneer`} package and is comprised by:

- Species longevity data: A data frame describing the Origination Time (TS) and
    Extinction Time (TE) obtained with Bayesian 
    framework called [PyRate]() 

- Occurrence recorda data:

- Species traits:



# Loading data and packages

```{r}

data("df_longevities_canidae") # longevities for one replicate
#data("occurrences_canidae") # occurrence data
data("traits_canidae") # trait data
data("df_occurrence_canidae") # occurrence data
```

# Interspecific competition at clade level


## Regional scale

Calculating time series at clade level and regional scale

```{r}
res_clade_regional <-
  clade_regional_coexistence(df.TS.TE = df_longevities_canidae,
                             time.slice = 0.1,
                             round.digits = 10,
                             species = "species",
                             TS = "TS",
                             TE = "TE")

```


Here we calculate the mean distances using a general function that
    allows to set up the group comparison in which the mean will be
    calculate. It can be `between` to calculate mean distances between a
    focal and a target group or `within` to calculate the mean trait
    distance only within the focal group. To this end we will use the `diet_cat` 
    column of the `trait_canidae` data frame, that contains a  
    classification of canidae species in two categories: hypercarnivores and 
    mesocarnivores.
    
First we need to join this information to the `df_longvities_canidae`
    data frame
    
```{r}
df_longevities_canidae_trait <- 
  df_longevities_canidae |> 
  left_join(traits_canidae, by = "species")

```

This function is also a general solution to calculate the mean trait
    distance using different number of species/genus that are close to each
    other. To set up the number of closest species that will be used in the 
    calculation of mean pairwise distances we will change the argument 
    `nearest.taxon`. 1 is equivalent of mean nearest distance and `all` 
    corresponds to the calculation of mean pairwise distance (mpd) using all
    coexisting species.

The next chunk of code show an example on how we can calculate mean distances 
    in the morphospace using different types of comparisons and varying the 
    number of closest species in the morphospace considered in the calculation

```{r}
dist_body_mass <- dist(traits_canidae$LD1) # computing pairwise distance matrix for body mass

res_regional_mpd <- 
  clade_regional_distance(df.TS.TE = df_longevities_canidae_trait, 
                          time.slice = 0.1,
                          dist.trait = dist_body_mass,
                          nearest.taxon = "all", 
                          round.digits = 10, 
                          species = "species", 
                          TS = "TS", 
                          TE = "TE")


res_regional_mnnd <- 
  clade_regional_distance(df.TS.TE = df_longevities_canidae_trait, 
                          time.slice = 0.1,
                          dist.trait = dist_body_mass,
                          nearest.taxon = 1, 
                          round.digits = 1, 
                          species = "species", 
                          TS = "TS", 
                          TE = "TE")

# distances between groups using diet category 
res_regional_mnd_between <- 
  clade_regional_distance(df.TS.TE = df_longevities_canidae_trait, 
                          time.slice = 0.1,
                          dist.trait = dist_body_mass,
                          nearest.taxon = 1, 
                          round.digits = 1, 
                          species = "species", 
                          TS = "TS", 
                          TE = "TE", 
                          group = "diet_cat",
                          group.focal.compare = c("meso", "hyper"),
                          type.comparison = "between")


# distance in morphospace computed within the focal group, in this case is mesocarnivores
res_regional_mnd_within <- 
  clade_regional_distance(df.TS.TE = df_longevities_canidae_trait, 
                          time.slice = 0.1,
                          dist.trait = dist_body_mass,
                          nearest.taxon = 1, 
                          round.digits = 1, 
                          species = "species", 
                          TS = "TS", 
                          TE = "TE", 
                          group = "diet_cat", 
                          group.focal.compare = c("meso", "meso"), 
                          type.comparison = "within")
```

Let's check out the results of these two competition metrics. First we need 
    to join the results to plot in one graphic

```{r}
all_mnd_regional <- rbind(res_regional_mpd, res_regional_mnd_between, res_regional_mnd_within)
all_mnd_regional2 <- 
  data.frame(all_mnd_regional, 
             group_res = rep(c("All", "Between", "Within"), 
                             each = nrow(res_regional_mnd_within))
  )

```


Plotting the results

```{r, dpi=300, fig.retina=2}
res_clade_regional |>
  mutate(time.slice = as.numeric(time.slice)) |>
  ggplot(aes(x = time.slice, y = coexistence)) +
  geom_smooth(
    se = TRUE,
    method = "loess",
    linewidth = 0.6
  ) +
  geom_line(
    linewidth = 0.4
  ) +
  labs(
    x = "Time (Ma)",
    y = "Coexistence"
  ) +
  scale_x_reverse(
    breaks = seq(
      from = 0,
      to   = max(res_clade_regional$time.slice, na.rm = TRUE),
      by   = 5
    )
  ) +
  theme_minimal(base_size = 10) +
  theme(
    legend.position = "none",
    axis.line = element_line(color = "black", linewidth = 0.4),
    axis.title = element_text(size = 9),
    axis.text  = element_text(size = 7),
    axis.title.x = element_text(size = 9),
    axis.title.y = element_text(size = 9),
    panel.grid.minor = element_blank()
  )


# mean pairwise distance

all_plots_raw_mnnd <- 
  ggplot(all_mnd_regional2, 
         aes(x = as.numeric(time.slice), 
             y = mean.distance, 
             color = group_res)
         ) +
  geom_smooth(se = TRUE, 
              method = "loess",
              span = 0.75, 
              alpha = 0.2,  
              linewidth = 3) +
  scale_x_reverse() +
  scale_y_continuous(breaks = pretty(res_all_dist2$mean.distance, n = 10)) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    legend.position = "none",
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"), 
    axis.text.x = element_text(size = 12), 
    axis.text.y = element_text(size = 12), 
    axis.title.x = element_text(size = 15),
    axis.title.y = element_text(size = 15)
  ) +
  scale_color_manual(values = c("Clade Regional" = "#E41A1C", "Clade Site" = "#755649", "Assemblage (Site)" = "#9fb493", "Assemblage (Grid 100)" = "#9cc21a")) + 
  labs(x = "Time (Ma)", y = "Mean Pairwise Distance") 

```


## Site scale

```{r, eval=FALSE}
res_clade_site <- 
  clade_site_coexistence(df.TS.TE = df_longevities_canidae, 
                         df.occ = df_occurrence_canidae, 
                         time.slice = 0.1, 
                         round.digits = 1,
                         species = "species",
                         TS = "TS",
                         TE = "TE", 
                         Max.age = "max_T",
                         Min.age = "min_T",
                         site = "site.char")


```

Plotting the results

```{r, fig.retina=2, eval=FALSE}
res_clade_site |> 
  ggplot(aes(x = as.numeric(time.slice), y = mean.coexistence)) +
  geom_line(aes(x = as.numeric(time.slice), y = mean.coexistence)) +
  geom_smooth(se = TRUE, method = "loess", size = 1) +  # Line thickness for better visibility
  labs(title = "",
       x = "Time (Ma)",
       y = "Mean site coexistence") +
  scale_x_continuous(breaks = seq(max(as.numeric(res_clade_site$time.slice)), 0, by = -10)) +
  scale_x_reverse() +
  theme_minimal(base_size = 10) +
  theme(
    legend.position = "none",
    axis.line = element_line(color = "black", linewidth = 0.4),
    axis.title = element_text(size = 9),
    axis.text  = element_text(size = 7),
    axis.title.x = element_text(size = 9),
    axis.title.y = element_text(size = 9),
    panel.grid.minor = element_blank()
  )
```

We can also calculate the distance in morphospace using site criteria 

```{r}

res_clade_site_distance <- 
  clade_site_distance(df.TS.TE = df_longevities_canidae, 
                      df.occ = df_occurrence_canidae, 
                      time.slice = 0.1, 
                      round.digits = 10,
                      dist.trait = dist_body_mass, 
                      nearest.taxon = "all",
                      species = "species",
                      TS = "TS",
                      TE = "TE", 
                      Max.age = "max_T",
                      Min.age = "min_T",
                      site = "site.char")


res_clade_site_distance_mnnd <- 
  clade_site_distance(df.TS.TE = df_longevities_canidae, 
                      df.occ = df_occurrence_canidae, 
                      time.slice = 0.1, 
                      round.digits = 1,
                      dist.trait = dist_body_mass, 
                      nearest.taxon = 1,
                      species = "species",
                      TS = "TS",
                      TE = "TE", 
                      Max.age = "max_T",
                      Min.age = "min_T",
                      site = "site.char")

# calculating between mesocarnivores and hypercarnivores species
res_clade_site_distance_between <- 
  clade_site_distance(df.TS.TE = df_longevities_canidae_trait, 
                      df.occ = df_occurrence_canidae, 
                      time.slice = 0.1, 
                      round.digits = 1,
                      dist.trait = dist_body_mass, 
                      nearest.taxon = 1, 
                      group = "diet_cat", 
                      group.focal.compare = c("meso", "hyper"), 
                      type.comparison = "between",
                      species = "species",
                      TS = "TS",
                      TE = "TE", 
                      Max.age = "max_T",
                      Min.age = "min_T",
                      site = "site.char")

# calculating within mesocarnivore species
res_clade_site_distance_within <- 
  clade_site_distance(df.TS.TE = df_longevities_canidae_trait, 
                      df.occ = df_occurrence_canidae, 
                      time.slice = 0.1, 
                      round.digits = 1,
                      dist.trait = dist_body_mass, 
                      nearest.taxon = 1, 
                      group = "diet_cat", 
                      group.focal.compare = c("meso", "meso"), 
                      type.comparison = "within",
                      species = "species",
                      TS = "TS",
                      TE = "TE", 
                      Max.age = "max_T",
                      Min.age = "min_T",
                      site = "site.char")
```

Let's check out the results of these competition metrics. First we need 
    to join the results to plot in one graphic

```{r}
all_mnd_site <- rbind(res_clade_site_distance, res_clade_site_distance_between, res_clade_site_distance_within)
all_mnd_site2 <- 
  data.frame(all_mnd_site, 
             group_res = rep(c("All", "Between", "Within"), 
                             each = nrow(res_clade_site_distance))
  )

```


Plotting the results

```{r}
all_mnd_site2 |> 
  ggplot(aes(x = as.numeric(time.slice), y = mean.distance, group = group_res, color = group_res)) +
  geom_line(aes(x = as.numeric(time.slice), y = mean.distance)) +
  geom_smooth(se = TRUE, method = "loess", size = 0.5) +
  labs(title = "",
       x = "Time (Ma)",
       y = "Mean Nearest Distance",
       color = "Groups") +
  scale_x_continuous(breaks = seq(max(as.numeric(all_mnd_site2$time.slice)), 0, by = -10)) +
  scale_x_reverse() +
  theme_minimal(base_size = 10) +
  theme(
    axis.line = element_line(color = "black", linewidth = 0.4),
    axis.title = element_text(size = 9),
    axis.text  = element_text(size = 7),
    axis.title.x = element_text(size = 9),
    axis.title.y = element_text(size = 9),
    panel.grid.minor = element_blank()
  )
```


## Reach criteria

Reach criteria for coexistence 

```{r}
res_clade_reach_coexistence <- 
  clade_reach_coexistence(df.TS.TE = df_longevities_canidae,
                          df.occ = df_occurrence_canidae, 
                          time.slice = 0.1, 
                          round.digits = 5,
                          species = "species",
                          TS = "TS",
                          TE = "TE",
                          lat = "lat",
                          lon = "lng",
                          Max.age = "max_T",
                          Min.age = "min_T",
                          crs = 4326)


```


Reach criteria for mean trait distance metrics

```{r}
res_clade_reach_distance <- 
  clade_reach_distance(df.TS.TE = df_longevities_canidae,
                       df.occ = df_occurrence_canidae, 
                       time.slice = 0.1, 
                       dist.trait = dist_body_mass, 
                       nearest.taxon = 1,
                       round.digits = 5, 
                       species = "species", 
                       TS = "TS",
                       TE = "TE",
                       lat = "lat",
                       lon = "lng",
                       Max.age = "max_T",
                       Min.age = "min_T",
                       crs = 4326)

res_clade_reach_distance_between <- 
  clade_reach_distance(df.TS.TE = df_longevities_canidae_trait,
                       df.occ = df_occurrence_canidae, 
                       time.slice = 0.1, 
                       group = "diet_cat",
                       group.focal.compare = c("meso", "hyper"),
                       type.comparison = "between", 
                       dist.trait = dist_body_mass, 
                       nearest.taxon = 1,
                       round.digits = 5, 
                       species = "species", 
                       TS = "TS",
                       TE = "TE",
                       lat = "lat",
                       lon = "lng",
                       Max.age = "max_T",
                       Min.age = "min_T",
                       crs = 4326)

res_clade_reach_distance_within <- 
  clade_reach_distance(df.TS.TE = df_longevities_canidae_trait,
                       df.occ = df_occurrence_canidae, 
                       time.slice = 0.1, 
                       group = "diet_cat",
                       group.focal.compare = c("meso", "hyper"),
                       type.comparison = "within", 
                       dist.trait = dist_body_mass, 
                       nearest.taxon = 1,
                       round.digits = 5, 
                       species = "species", 
                       TS = "TS",
                       TE = "TE",
                       lat = "lat",
                       lon = "lng",
                       Max.age = "max_T",
                       Min.age = "min_T",
                       crs = 4326)


```

Joining the results and plotting

```{r}
all_mnd_clade_reach <- rbind(res_clade_reach_distance, res_clade_reach_distance_between, res_clade_reach_distance_within)
all_mnd_clade_reach2 <- 
  data.frame(all_mnd_clade_reach, 
             group_res = rep(c("All", "Between", "Within"), 
                             each = nrow(res_clade_reach_distance))
  )
```

Plotting 

```{r}
all_mnd_clade_reach2 |> 
  ggplot(aes(x = as.numeric(time.slice), y = mean.distance, group = group_res, color = group_res)) +
  geom_line(aes(x = as.numeric(time.slice), y = mean.distance)) +
  geom_smooth(se = TRUE, method = "loess", size = 0.5) +
  labs(title = "",
       x = "Time (Ma)",
       y = "Mean Nearest Distance",
       color = "Groups") +
  scale_x_continuous(breaks = seq(max(as.numeric(all_mnd_clade_reach2$time.slice)), 0, by = -10)) +
  scale_x_reverse() +
  theme_minimal(base_size = 10) +
  theme(
    axis.line = element_line(color = "black", linewidth = 0.4),
    axis.title = element_text(size = 9),
    axis.text  = element_text(size = 7),
    axis.title.x = element_text(size = 9),
    axis.title.y = element_text(size = 9),
    panel.grid.minor = element_blank()
  )
```


# Interspecific Competition at Individual Species Level

In individual species analyses the focus is on the "perception" of each
individual species with other co-occurring species. There are two main
components in this module. The first computes the number of species in
which a given species co-occur. The other is the mean distance between a
focal individual and its co-occurring species.

As the other modules there are four spatial levels in which we compute
the metrics. The regional level, that calculates the number of
co-occurrence by each focal species and all other species with
occurrence data in the specified time-slice. The site level, that
compute the taxonomic and trait metrics considering as co-existing
species only those that present occurrence in the same site (usually
defined accordingly to the PBDB definition of a site, or another
definition provided by the user). The reach level, that considers a
proxy of species dispersal capacity to infer the species that
potentially co-occurr. Finally, the assemblage level, that considers as
species co-occurring only those with an occurrence record in the same
assemblage, this last being defined as a grid of customized size.

## Regional scale

```{r}
res_indiv_species_coex <- 
  IndivSpecies_regional_coex(df.TS.TE = df_longevities_canidae, 
                             time.slice = 0.1,
                             round.digits = 1,
                             species = "species",
                             TS = "TS",
                             TE = "TE")

```


We can plot the time series for each species

```{r,fig.retina=2}
res_indiv_species_coex |>
  filter(
    species %in% c(
      "Aelurodon_ferox",
      "Psalidocyon_marianae",
      "Aelurodon_taxoides",
      "Phlaocyon_marslandensis"
    )
  ) |>
  ggplot(
    aes(
      x = time.slice,
      y = n.coexistence,
      color = species,
      group = species
    )
  ) +
  geom_smooth(
    se = TRUE,
    method = "loess",
    linewidth = 0.8
  ) +
  geom_line(
    linewidth = 0.5
  ) +
  facet_wrap(~ species, nrow = 2) +
  labs(
    x = "Time",
    y = "Number of coexistences by species"
  ) +
  scale_x_reverse(
    breaks = seq(
      from = 0,
      to   = max(res_indiv_species_coex$time.slice, na.rm = TRUE),
      by   = 10
    )
  ) +
  coord_cartesian(clip = "off") +
  theme_minimal(base_size = 10) +
    theme(
    legend.position = "none",
    axis.line.x.bottom = element_line(color = "black", linewidth = 0.4),
    axis.ticks.x       = element_line(color = "black", linewidth = 0.4),
    axis.text.x        = element_text(size = 8),
    axis.line.y.left   = element_line(color = "black", linewidth = 0.4),
    panel.grid.minor   = element_blank(),
    plot.margin = margin(t = 5, r = 5, b = 20, l = 5)
  )

```

We can also plot individual species mpd for all species coexisting in
regional context. For this we will also use data on body mass for all
species. There are different ways in which mpd can be calculated. We can
calculate it using a single trait or a combination of traits. The later
require a distance trait matrix (passed to `dist` argument) containing
the pairwise distances among species.

Here we show how to calculate mpd using a single trait, in this case
body mass.

```{r}

res_indiv_regional_species_mpd <-
  IndivSpec_regional_distance(df.TS.TE = df_longevities_canidae,
                              time.slice = 0.1, 
                              dist.trait = dist_body_mass,
                              round.digits = 1, 
                              species = "species",
                              TS = "TS",
                              TE = "TE", 
                              nearest.taxon = "all")

```

Plotting the results for individual species mpd

```{r, fig.retina=2}
res_indiv_regional_species_mpd |>
  filter(
    species %in% c(
      "Aelurodon_ferox",
      "Psalidocyon_marianae",
      "Aelurodon_taxoides",
      "Phlaocyon_marslandensis"
    )
  ) |>
  ggplot(
    aes(
      x = time.slice,
      y = mean_dist_to_cooccur,
      color = species,
      group = species
    )
  ) +
  geom_smooth(
    se = TRUE,
    method = "loess",
    linewidth = 0.8
  ) +
  geom_line(
    linewidth = 0.5
  ) +
  facet_wrap(~ species, nrow = 2) +
  labs(
    x = "Time (Ma)",
    y = "Mean pairwise distance"
  ) +
  scale_x_reverse(
    breaks = seq(
      from = 0,
      to   = max(res_indiv_regional_species_mpd$time.slice, na.rm = TRUE),
      by   = 10
    )
  ) +
  coord_cartesian(clip = "off") +
  theme_minimal(base_size = 10) +
    theme(
    legend.position = "none",
    axis.line.x.bottom = element_line(color = "black", linewidth = 0.4),
    axis.ticks.x       = element_line(color = "black", linewidth = 0.4),
    axis.text.x        = element_text(size = 8),
    axis.line.y.left   = element_line(color = "black", linewidth = 0.4),
    panel.grid.minor   = element_blank(),
    plot.margin = margin(t = 5, r = 5, b = 20, l = 5)
  )

```


In order to calculate the mpd for multiple traits the user must inform
an object of class dist containing all pairwise distances among species.
The function can handle distances in different ways. It can use all
pairwise distances to obtain the mpd, or the user can inform throught
the argument `nearest.taxon` the number of nearest species that will be
used to calculate the mpd. The default is `all` which is the same as
calculating the mpd considering all species co-occurring in a time
slice.

```{r}
res_indiv_regional_species_mnd <- 
  IndivSpec_regional_distance(df.TS.TE = df_longevities_canidae, 
                            time.slice = 0.1, 
                            dist.trait = dist_body_mass, 
                            nearest.taxon = 1,
                            round.digits = 1, 
                            species = "species",
                            TS = "TS",
                            TE = "TE")
```

## Site scale

Here we will perform the same calculations but using site criteria for
individual species coexistence

```{r}
res_indiv_species_site_coex <- 
  IndivSpec_site_coexistence(df.TS.TE = df_longevities_canidae,
                             df.occ = df_occurrence_canidae, 
                             time.slice = 0.1,
                             round.digits = 5,
                             species = "species",
                             TS = "TS",
                             TE = "TE",
                             Max.age = "max_T",
                             Min.age = "min_T",
                             site = "site.char")



```

plotting species coexistence considering site coexistence

```{r,fig.retina=2}
res_indiv_species_site_coex |>
  filter(
    species %in% c(
      "Aelurodon_ferox",
      "Psalidocyon_marianae",
      "Aelurodon_taxoides",
      "Phlaocyon_marslandensis"
    )
  ) |>
  ggplot(
    aes(
      x = time.slice,
      y = n.coexistence,
      color = species,
      group = species
    )
  ) +
  geom_smooth(
    se = TRUE,
    method = "loess",
    linewidth = 0.8
  ) +
  geom_line(
    linewidth = 0.5
  ) +
  facet_wrap(~ species, nrow = 2) +
  labs(
    x = "Time",
    y = "Number of coexistences by species"
  ) +
  scale_x_reverse(
    breaks = seq(
      from = 0,
      to   = max(res_indiv_species_coex$time.slice, na.rm = TRUE),
      by   = 10
    )
  ) +
  coord_cartesian(clip = "off") +
  theme_minimal(base_size = 10) +
    theme(
    legend.position = "none",
    axis.line.x.bottom = element_line(color = "black", linewidth = 0.4),
    axis.ticks.x       = element_line(color = "black", linewidth = 0.4),
    axis.text.x        = element_text(size = 8),
    axis.line.y.left   = element_line(color = "black", linewidth = 0.4),
    panel.grid.minor   = element_blank(),
    plot.margin = margin(t = 5, r = 5, b = 20, l = 5)
  )
```


We can calculate mean pairwise distances of individual species
coexistence metrics based on site co-occurrence

```{r}

indiv_species_site_mpd <- 
  IndivSpec_site_distance(df.TS.TE = df_longevities_canidae, 
                     df.occ = df_occurrence_canidae, 
                     time.slice = 0.1, 
                     dist.trait = dist_body_mass, 
                     nearest.taxon = "all",
                     round.digits = 1,
                     species = "species",
                     TS = "TS",
                     TE = "TE",
                     Max.age = "max_T",
                     Min.age = "min_T",
                     site = "site.char")


```

## Reach criteria

We will calculate individual mean coexistence using reach criteria

```{r}

res_indiv_species_reach_coex <- 
  IndivSpecies_reach_coexistence(df.TS.TE = df_longevities_canidae,
                                 df.occ = df_occurrence_canidae,
                                 time.slice = 0.1, 
                                 round.digits = 1,
                                 species = "species",
                                 TS = "TS",
                                 TE = "TE",
                                 Max.age = "max_T",
                                 Min.age = "min_T",
                                 lat = "lat",
                                 lon = "lng")

```

plotting individual species coexistence with reach criteria

```{r,fig.retina=2}

res_indiv_species_reach_coex |>
  filter(
    species %in% c(
      "Aelurodon_ferox",
      "Psalidocyon_marianae",
      "Aelurodon_taxoides",
      "Phlaocyon_marslandensis"
    )
  ) |>
  ggplot(
    aes(
      x = time.slice,
      y = n.coexistence,
      color = species,
      group = species
    )
  ) +
  geom_smooth(
    se = TRUE,
    method = "loess",
    linewidth = 0.8
  ) +
  geom_line(
    linewidth = 0.5
  ) +
  facet_wrap(~ species, nrow = 2) +
  labs(
    x = "Time",
    y = "Number of coexistences by species"
  ) +
  scale_x_reverse(
    breaks = seq(
      from = 0,
      to   = max(res_indiv_species_reach_coex$time.slice, na.rm = TRUE),
      by   = 3
    )
  ) +
  coord_cartesian(clip = "off") +
  theme_minimal(base_size = 10) +
    theme(
    legend.position = "none",
    axis.line.x.bottom = element_line(color = "black", linewidth = 0.4),
    axis.ticks.x       = element_line(color = "black", linewidth = 0.4),
    axis.text.x        = element_text(size = 8),
    axis.line.y.left   = element_line(color = "black", linewidth = 0.4),
    panel.grid.minor   = element_blank(),
    plot.margin = margin(t = 5, r = 5, b = 20, l = 5)
  )
```

Individual reach coexistence mpd and mnd

```{r}
res_indiv_species_reach_distance <- 
  IndivSpec_reach_distance(df.TS.TE = df_longevities_canidae, 
                           dist.trait = dist_body_mass, 
                           nearest.taxon = "all",
                           crs = 4326, 
                           df.occ = df_occurrence_canidae,
                           time.slice = 0.1, 
                           round.digits = 1,
                           species = "species",
                           TS = "TS",
                           TE = "TE",
                           Max.age = "max_T",
                           Min.age = "min_T",
                           lat = "lat",
                           lon = "lng")
```

Plotting the result

```{r}
res_indiv_species_reach_distance |>
  filter(
    species %in% c(
      "Aelurodon_ferox",
      "Psalidocyon_marianae",
      "Aelurodon_taxoides",
      "Phlaocyon_marslandensis"
    )
  ) |>
  ggplot(
    aes(
      x = time.slice,
      y = mean_dist_to_cooccur,
      color = species,
      group = species
    )
  ) +
  geom_smooth(
    se = TRUE,
    method = "loess",
    linewidth = 0.8
  ) +
  geom_line(
    linewidth = 0.5
  ) +
  facet_wrap(~ species, nrow = 2) +
  labs(
    x = "Time (Ma)",
    y = "Mean individual distance in morphospace"
  ) +
  scale_x_reverse(
    breaks = seq(
      from = 0,
      to   = max(res_indiv_species_reach_distance$time.slice, na.rm = TRUE),
      by   = 10
    )
  ) +
  coord_cartesian(clip = "off") +
  theme_minimal(base_size = 10) +
    theme(
    legend.position = "none",
    axis.line.x.bottom = element_line(color = "black", linewidth = 0.4),
    axis.ticks.x       = element_line(color = "black", linewidth = 0.4),
    axis.text.x        = element_text(size = 8),
    axis.line.y.left   = element_line(color = "black", linewidth = 0.4),
    panel.grid.minor   = element_blank(),
    plot.margin = margin(t = 5, r = 5, b = 20, l = 5)
  )
```

# Interspecific Competition at Assemblage Level


## Site (collection)

First using site (collection) scale

```{r}
res_assemblage_site_mpd <- 
  assemblage_site_trait_distance_null(df.TS.TE = df_longevities_canidae, 
                                      df.occ = df_occurrence_canidae, 
                                      time.slice = 0.1,
                                      dist_matrix_trait = dist_body_mass, 
                                      round.digits = 10, 
                                      species = "species", 
                                      TS = "TS",
                                      TE = "TE",
                                      Max.age = "max_T", 
                                      Min.age = "min_T",
                                      site = "site.char", 
                                      nearest.taxon = "mpd",
                                      nperm = 999, 
                                      fixedmar = "rows",
                                      mtype = "prab")

res_assemblage_site_mnnd <- 
  assemblage_site_trait_distance_null(df.TS.TE = df_longevities_canidae, 
                                      df.occ = df_occurrence_canidae, 
                                      time.slice = 0.1,
                                      dist_matrix_trait = dist_body_mass, 
                                      round.digits = 10, 
                                      species = "species", 
                                      TS = "TS",
                                      TE = "TE",
                                      Max.age = "max_T", 
                                      Min.age = "min_T",
                                      site = "site.char", 
                                      nearest.taxon = "mnnd",
                                      nperm = 999, 
                                      fixedmar = "rows",
                                      mtype = "prab")
```

## Grid (assemblage) scale

First we need to assemble the grid 

```{r}
df_grid_100 <- 
  palaeoverse::bin_space(occdf = df_occurrence_canidae,
                         lng = "lng",
                         lat = "lat",
                         spacing = 100) # 100 km grid

df_grid_50 <- 
  palaeoverse::bin_space(occdf = df_occurrence_canidae, 
                         lng = "lng",
                         lat = "lat",
                         spacing = 50) # average grid size 30km


```

calculating pairwise distance for grids

```{r}
res_assemblage_grid_100_mpd <- 
  assemblage_site_trait_distance_null(df.TS.TE = df_longevities_canidae, 
                                      df.occ = df_grid_100, 
                                      time.slice = 0.1,
                                      dist_matrix_trait = dist_body_mass, 
                                      round.digits = 10, 
                                      species = "species", 
                                      TS = "TS",
                                      TE = "TE",
                                      Max.age = "max_T", 
                                      Min.age = "min_T",
                                      site = "cell_ID", 
                                      nearest.taxon = "mpd",
                                      nperm = 999, 
                                      fixedmar = "rows",
                                      mtype = "prab")

res_assemblage_grid_100_mnnd <- 
  assemblage_site_trait_distance_null(df.TS.TE = df_longevities_canidae, 
                                      df.occ = df_grid_100, 
                                      time.slice = 0.1,
                                      dist_matrix_trait = dist_body_mass, 
                                      round.digits = 10, 
                                      species = "species", 
                                      TS = "TS",
                                      TE = "TE",
                                      Max.age = "max_T", 
                                      Min.age = "min_T",
                                      site = "cell_ID", 
                                      nearest.taxon = "mnnd",
                                      nperm = 999, 
                                      fixedmar = "rows",
                                      mtype = "prab")


```

# Plotting all results for mpd

```{r}

colnames(res_assemblage_grid_100_mpd) <- c("mean.distance", 
                                           "dist.obs.z",
                                           "p.value",
                                           "time.slice")

colnames(res_assemblage_site_mpd) <- c("mean.distance", 
                                       "dist.obs.z",
                                       "p.value",
                                       "time.slice")



res_all_dist_mpd <- 
  rbind(res_regional_mpd[, c("mean.distance", "time.slice")], 
        res_assemblage_site_mpd[, c("mean.distance", "time.slice")], 
        res_assemblage_grid_100_mpd[, c("mean.distance", "time.slice")])

res_all_dist_mpd2 <- 
  data.frame(res_all_dist_mpd, 
             group = rep(c("Clade Regional", 
                           "Assemblage (Site)",
                           "Assemblage (Grid 100)"), 
                         times = c(dim(res_regional_mpd)[1],
                                   dim(res_assemblage_site_mpd)[1],
                                   dim(res_assemblage_grid_100_mpd)[1])
                         )
  )


all_plots_raw_mpd <- 
  ggplot(res_all_dist_mpd2, aes(x = as.numeric(time.slice), y = mean.distance, color = group)) +
  geom_smooth(se = TRUE, method = "loess", span = 0.75, alpha = 0.2,  linewidth = 3) +
  scale_x_reverse() +
  scale_y_continuous(breaks = pretty(res_all_dist_mpd2$mean.distance, n = 10)) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    #legend.position = "none",
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"), 
    axis.text.x = element_text(size = 12), 
    axis.text.y = element_text(size = 12), 
    axis.title.x = element_text(size = 15),
    axis.title.y = element_text(size = 15)
  ) +
  scale_color_manual(values = c("Clade Regional" = "#E41A1C", "Assemblage (Site)" = "#9fb493", "Assemblage (Grid 100)" = "#9cc21a")) + # Customize as needed
  labs(x = "Time (Ma)", y = "Mean Pairwise Distance") +
  annotate("text", x = 2, y = 0.46, 
           label = "Clade Regional",
           color = "#E41A1C",
           size = 5, fontface="bold") +
  annotate("text", x = 2, y = 1.27, 
           label = "Assemblage (Grid 100)", 
           color = "#9cc21a", 
           size = 5, fontface="bold") +
  annotate("text", x = 2, y = 1.73, 
           label = "Assemblage (Site)",
           color = "#755649",
           size = 5, fontface="bold")
  
  
  
plots_sub_mpd_raw  <- 
  res_all_dist2 |> 
  filter(group == "Assemblage (site)" | group == "Regional" | group == "Regional site")  |> 
  ggplot(aes(x = as.numeric(time.slice), y = mean.distance, color = group)) +
  geom_smooth(se = TRUE, method = "loess", span = 0.75, alpha = 0.2,  linewidth = 3) +
  scale_x_reverse() +
  scale_y_continuous(breaks = pretty(res_all_dist2$mean.distance, n = 10)) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    legend.position = "none",
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"), 
    axis.text.x = element_text(size = 12), 
    axis.text.y = element_text(size = 12), 
    axis.title.x = element_text(size = 15),
    axis.title.y = element_text(size = 15)
  ) +
  scale_color_manual(values = c("Regional" = "#E41A1C", "Assemblage (site)" = "#9fb493", "Regional site" = "#755649")) + # Customize as needed
  labs(x = "Time (Ma)", y = "Mean Pairwise Distance") +
  annotate("text", x = 2, y = 0.46, 
           label = "Regional",
           color = "#E41A1C",
           size = 5, fontface="bold") +
  annotate("text", x = 2, y = 1.27, 
           label = "Assemblage", 
           color = "#9fb493", 
           size = 5, fontface="bold") +
  annotate("text", x = 2, y = 1.73, 
           label = "Site",
           color = "#755649",
           size = 5, fontface="bold")


ggsave(here::here("inst", 
                  "extdata",
                  "figures_canidae",
                  "plot_all_scale_mpd_raw2.png"),
       plots_sub_mpd_raw, 
       width = 10, 
       height = 10, 
       dpi = 800,
       bg = "white")
```

Plotting standardized effect size

```{r}

res_assemblage_site_mpd$significant <- res_assemblage_site_mpd$p.value <= 0.05
res_assemblage_grid_100_mpd$significant <- res_assemblage_grid_100_mpd$p.value <= 0.05

plot_site_ses_mpd <- 
  ggplot(res_assemblage_site_mpd, aes(x = as.numeric(time.slice), y = dist.obs.z)) +
  # geom_line(color = "grey50", alpha = 0.4) +  # Transparent line
  geom_point(aes(color = significant), size = 2, alpha = 0.4) +  # Transparent points
  geom_smooth(method = "loess", se = TRUE, color = "#61c2e2", size = 2) +
  scale_color_manual(values = c("TRUE" = "#e12a44", "FALSE" = "#9fb493")) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  scale_x_reverse() +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid = element_blank(),
    legend.position = "none",
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"), 
    axis.text.x = element_text(size = 12), 
    axis.text.y = element_text(size = 12), 
    axis.title.x = element_text(size = 15),
    axis.title.y = element_text(size = 12)
  ) +
  labs(x = "Time (Ma)", y = "Mean observed distance - Mean null distance / 
           SD null distance")

plot_site_ses_mpd2 <- 
  plot_site_ses_mpd +
  annotate("segment",
           x = 9.8, y = 2.4,     # point location
           xend = 12, yend = 3.2, # label location
           color = "#e12a44", size = 0.6) +
  annotate("text",
           x = 12.2, y = 3.2,
           label = "different from expected 
               under null model",
           hjust = 0, size = 4)

plot_grid_ses_mpd <- 
  ggplot(res_assemblage_grid_100_mpd, aes(x = as.numeric(time.slice), y = dist.obs.z)) +
  # geom_line(color = "grey50", alpha = 0.4) +  # Transparent line
  geom_point(aes(color = significant), size = 2, alpha = 0.4) +  # Transparent points
  geom_smooth(method = "loess", se = TRUE, color = "#61c2e2", size = 2) +
  scale_color_manual(values = c("TRUE" = "#e12a44", "FALSE" = "#9fb493")) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  scale_x_reverse() +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid = element_blank(),
    legend.position = "none",
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"), 
    axis.text.x = element_text(size = 12), 
    axis.text.y = element_text(size = 12), 
    axis.title.x = element_text(size = 15),
    axis.title.y = element_text(size = 15)
  ) +
  labs(x = "Time (Ma)", y = "Mean pairwise distance - Mean null pairwise / 
           SD null pairwise")
plot_grid_ses_mpd
```

Doing the same for mnnd

```{r}

colnames(res_assemblage_grid_100_mnnd) <- c("mean.distance", 
                                           "dist.obs.z",
                                           "p.value",
                                           "time.slice")

colnames(res_assemblage_site_mnnd) <- c("mean.distance", 
                                       "dist.obs.z",
                                       "p.value",
                                       "time.slice")



res_all_dist_mnnd <- 
  rbind(res_regional_mnnd[, c("mean.distance", "time.slice")], 
        res_clade_site_distance_mnnd[, c("mean.distance", "time.slice")], 
        res_assemblage_site_mnnd[, c("mean.distance", "time.slice")], 
        res_assemblage_grid_100_mnnd[, c("mean.distance", "time.slice")])

res_local_dist_mnnd <- 
  rbind(res_regional_mnnd[, c("mean.distance", "time.slice")], 
        res_assemblage_site_mnnd[, c("mean.distance", "time.slice")], 
        res_assemblage_grid_100_mnnd[, c("mean.distance", "time.slice")])

res_all_dist2_mnnd <- 
  data.frame(res_all_dist_mnnd, 
             group = rep(c("Clade Regional", 
                           "Clade Site",
                           "Assemblage (Site)",
                           "Assemblage (Grid 100)"), 
                         times = c(dim(res_regional_mnnd)[1],
                                   dim(res_clade_site_distance_mnnd)[1],
                                   dim(res_assemblage_site_mnnd)[1],
                                   dim(res_assemblage_grid_100_mnnd)[1])
             )
  )

res_local_dist2_mnnd <- 
  data.frame(res_local_dist_mnnd, 
             group = rep(c("Clade Regional", 
                           "Assemblage (Site)",
                           "Assemblage (Grid 100)"), 
                         times = c(dim(res_regional_mnnd)[1],
                                   dim(res_assemblage_site_mnnd)[1],
                                   dim(res_assemblage_grid_100_mnnd)[1])
             )
  )


all_plots_raw_mnnd <- 
  ggplot(res_all_dist2_mnnd, 
         aes(x = as.numeric(time.slice), 
             y = mean.distance, 
             color = group)
         ) +
  geom_smooth(se = TRUE, 
              method = "loess",
              span = 0.75, 
              alpha = 0.2,  
              linewidth = 3) +
  scale_x_reverse() +
  scale_y_continuous(breaks = pretty(res_all_dist2$mean.distance, n = 10)) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    legend.position = "none",
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"), 
    axis.text.x = element_text(size = 12), 
    axis.text.y = element_text(size = 12), 
    axis.title.x = element_text(size = 15),
    axis.title.y = element_text(size = 15)
  ) +
  scale_color_manual(values = c("Clade Regional" = "#E41A1C", "Clade Site" = "#755649", "Assemblage (Site)" = "#9fb493", "Assemblage (Grid 100)" = "#9cc21a")) + 
  labs(x = "Time (Ma)", y = "Mean Nearest Neighbor Distance") +
  annotate("text", x = 2, y = 0.46, 
           label = "Clade Regional",
           color = "#E41A1C",
           size = 5, fontface="bold") +
  annotate("text", x = 28, y = 2.1, 
           label = "Assemblage (Site)", 
           color = "#9fb493", 
           size = 5, fontface="bold") +
  annotate("text", x = 28, y = 1.4, 
           label = "Assemblage (Grid 100)", 
           color = "#9cc21a", 
           size = 5, fontface="bold") +
  annotate("text", x = 2, y = 0.7, 
           label = "Clade Site",
           color = "#755649",
           size = 5, fontface="bold")
  
# alternative without site
all_local_plots_raw_mnnd <- 
  ggplot(res_local_dist2_mnnd, 
         aes(x = as.numeric(time.slice), 
             y = mean.distance, 
             color = group)
         ) +
  geom_smooth(
  data = ~ subset(.x, group != "Clade Regional"),
  se = TRUE,
  method = "loess",
  span = 0.75,
  alpha = 0.2,
  linewidth = 3
) +
geom_line(
  data = ~ subset(.x, group == "Clade Regional"),
  linewidth = 1
) +
  scale_x_reverse() +
  scale_y_continuous(breaks = pretty(res_local_dist2_mnnd$mean.distance, n = 10)) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    legend.position = "none",
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"), 
    axis.text.x = element_text(size = 26), 
    axis.text.y = element_text(size = 26), 
    axis.title.x = element_text(size = 26),
    axis.title.y = element_text(size = 26)
  ) +
  scale_color_manual(values = c("Clade Regional" = "#E41A1C", "Assemblage (Site)" = "#9fb493", "Assemblage (Grid 100)" = "#9cc21a")) + 
  labs(x = "Time (Ma)", y = "Mean Nearest Neighbor Distance") +
  annotate("text", x = 2, y = 0.46, 
           label = "Clade Regional",
           color = "#E41A1C",
           size = 5, fontface="bold") +
  annotate("text", x = 28, y = 2.1, 
           label = "Assemblage (Site)", 
           color = "#9fb493", 
           size = 5, fontface="bold") +
  annotate("text", x = 28, y = 1.4, 
           label = "Assemblage (Grid 100)", 
           color = "#9cc21a", 
           size = 5, fontface="bold")
  

ggsave(here::here("inst", "extdata", "figures_canidae", "plot_all_scale_mnnd_raw.png"),
       all_plots_raw_mnnd, 
       width = 10, 
       height = 10, 
       dpi = 800,
       bg = "white")

ggsave(here::here("inst", "extdata", "figures_canidae", "plot_local_scale_mnnd_raw.png"),
       all_local_plots_raw_mnnd, 
       width = 10, 
       height = 10, 
       dpi = 800,
       bg = "white")

ggsave(here::here("inst", "extdata", "figures_canidae", "plot_site_ses_mpd.png"),
       plot_site_ses_mpd2, 
       width = 10, 
       height = 10, 
       dpi = 800,
       bg = "white")
```

Plotting standardized effect size for mnnd

```{r}
res_assemblage_site_mnnd$significant <- res_assemblage_site_mnnd$p.value <= 0.05
res_assemblage_grid_100_mnnd$significant <- res_assemblage_grid_100_mnnd$p.value <= 0.05
res_assemblage_grid_100_mpd$significant <- res_assemblage_grid_100_mpd$p.value <= 0.05

plot_grid100_ses_mnnd <- 
  ggplot(res_assemblage_grid_100_mnnd, aes(x = as.numeric(time.slice), y = dist.obs.z)) +
  # geom_line(color = "grey50", alpha = 0.4) +  # Transparent line
  geom_point(aes(color = significant), size = 2, alpha = 0.4) +  # Transparent points
  geom_smooth(method = "loess", se = TRUE, color = "#61c2e2", size = 2) +
  scale_color_manual(values = c("TRUE" = "#e12a44", "FALSE" = "#9fb493")) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  scale_x_reverse() +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid = element_blank(),
    legend.position = "none",
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"), 
    axis.text.x = element_text(size = 26), 
    axis.text.y = element_text(size = 26), 
    axis.title.x = element_text(size = 26),
    axis.title.y = element_text(size = 26)
  ) +
  labs(x = "Time (Ma)", y = "Mean observed distance - Mean null distance / 
           SD null distance")

plot_site_ses_mpd2 <- 
  plot_site_ses_mpd +
  annotate("segment",
           x = 9.8, y = 2.4,     # point location
           xend = 12, yend = 3.2, # label location
           color = "#e12a44", size = 0.6) +
  annotate("text",
           x = 12.2, y = 3.2,
           label = "different from expected 
               under null model",
           hjust = 0, size = 4)

# mnnd site

plot_site_ses_mnnd <- 
  ggplot(res_assemblage_site_mnnd, aes(x = as.numeric(time.slice), y = dist.obs.z)) +
  # geom_line(color = "grey50", alpha = 0.4) +  # Transparent line
  geom_point(aes(color = significant), size = 2, alpha = 0.4) +  # Transparent points
  geom_smooth(method = "loess", se = TRUE, color = "#61c2e2", size = 2) +
  scale_color_manual(values = c("TRUE" = "#e12a44", "FALSE" = "#9fb493")) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  scale_x_reverse() +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid = element_blank(),
    legend.position = "none",
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"), 
    axis.text.x = element_text(size = 12), 
    axis.text.y = element_text(size = 12), 
    axis.title.x = element_text(size = 15),
    axis.title.y = element_text(size = 12)
  ) +
  labs(x = "Time (Ma)", y = "Mean observed distance - Mean null distance / 
           SD null distance")

plot_site_ses_mnnd2 <- 
  plot_site_ses_mnnd +
  annotate("segment",
           x = 9.8, y = 2.4,     # point location
           xend = 12, yend = 3.2, # label location
           color = "#e12a44", size = 0.6) +
  annotate("text",
           x = 12.2, y = 3.2,
           label = "different from expected 
               under null model",
           hjust = 0, size = 4)


plot_site_ses_mpd2 <- 
  plot_site_ses_mpd +
  annotate("segment",
           x = 9.8, y = 2.4,     # point location
           xend = 12, yend = 3.2, # label location
           color = "#e12a44", size = 0.6) +
  annotate("text",
           x = 12.2, y = 3.2,
           label = "different from expected 
               under null model",
           hjust = 0, size = 4)


# mpd in grid 
plot_grid_ses_mpd <- 
  ggplot(res_assemblage_grid_100_mpd, aes(x = as.numeric(time.slice), y = dist.obs.z)) +
  # geom_line(color = "grey50", alpha = 0.4) +  # Transparent line
  geom_point(aes(color = significant), size = 2, alpha = 0.4) +  # Transparent points
  geom_smooth(method = "loess", se = TRUE, color = "#61c2e2", size = 2) +
  scale_color_manual(values = c("TRUE" = "#e12a44", "FALSE" = "#9fb493")) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  scale_x_reverse() +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid = element_blank(),
    legend.position = "none",
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"), 
    axis.text.x = element_text(size = 12), 
    axis.text.y = element_text(size = 12), 
    axis.title.x = element_text(size = 15),
    axis.title.y = element_text(size = 15)
  ) +
  labs(x = "Time (Ma)", y = "Mean pairwise distance - Mean null pairwise / 
           SD null pairwise")


ggsave(here::here("inst", "extdata", "figures_canidae", "plot_grid_100_ses_mpd.png"),
       plot_grid_ses_mpd, 
       width = 10, 
       height = 10, 
       dpi = 800,
       bg = "white")

ggsave(here::here("inst", "extdata", "figures_canidae", "plot_grid_100_ses_mnnd.png"),
       plot_grid100_ses_mnnd, 
       width = 10, 
       height = 10, 
       dpi = 800,
       bg = "white")


ggsave(here::here("inst", "extdata", "figures_canidae", "plot_site_ses_mnnd.png"),
       plot_site_ses_mnnd, 
       width = 10, 
       height = 10, 
       dpi = 800,
       bg = "white")

plot_site_ses_mnnd

```

Number of species in grid 

```{r}

res_assemblage_grid_100_richness <- 
  assemblage_nspecies(df.TS.TE = df_longevities_canidae, 
                      df.occ = df_grid_100, 
                      time.slice = 0.1, 
                      round.digits = 10, 
                      species = "species", 
                      TS = "TS",
                      TE = "TE", 
                      Max.age = "max_T", 
                      Min.age = "min_T",
                      site = "cell_ID")

res_assemblage_site_richness <- 
  assemblage_nspecies(df.TS.TE = df_longevities_canidae, 
                      df.occ = df_occurrence_canidae, 
                      time.slice = 0.1, 
                      round.digits = 10, 
                      species = "species", 
                      TS = "TS",
                      TE = "TE", 
                      Max.age = "max_T", 
                      Min.age = "min_T",
                      site = "site.char")

# regional richness

res_regional_clade_richness <- 
  clade_regional_coexistence(df.TS.TE = df_longevities_canidae, 
                             time.slice = 0.1,
                             round.digits = 10, 
                             species = "species",
                             TS = "TS",
                             TE = "TE")

res_regional_clade_richness$n.species <- res_regional_clade_richness$coexistence + 1

```

Plotting richness

```{r}

res_all_assemblage_richness <- 
  rbind(res_assemblage_site_richness[, c("time.slice", "n.species")], res_assemblage_grid_100_richness[, c("time.slice", "n.species")], res_regional_clade_richness[, c("time.slice", "n.species")])

res_all_assemblage_richness2 <- 
  data.frame(res_all_assemblage_richness, 
             group = rep(c("Assemblage (Site)",
                           "Assemblage (Grid 100)",
                           "Clade Regional"), 
                         times = c(dim(res_assemblage_site_richness)[1],
                                   dim(res_assemblage_grid_100_richness)[1], 
                                   dim(res_regional_clade_richness)[1])
             )
  )

all_plots_assemblage_richness <- 
  ggplot(res_all_assemblage_richness2, aes(x = as.numeric(time.slice), y = n.species, color = group)) +
  geom_smooth(se = TRUE, method = "loess", span = 0.75, alpha = 0.2,  linewidth = 3) +
  scale_x_reverse() +
  scale_y_continuous(breaks = pretty(1:4, n = 4)) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    legend.position = "none",
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"), 
    axis.text.x = element_text(size = 12), 
    axis.text.y = element_text(size = 12), 
    axis.title.x = element_text(size = 15),
    axis.title.y = element_text(size = 15)
  ) +
  scale_color_manual(values = c("Assemblage (Site)" = "#9fb493",
                                "Assemblage (Grid 100)" = "#9cc21a", 
                                "Clade Regional")) + 
  labs(x = "Time (Ma)", y = "Number of species in assemblages") + 
  annotate("text", x = 27.5, y = 1.1, 
           label = "Assemblage (Site)", 
           color = "#9fb493", 
           size = 5, fontface="bold") +
  annotate("text", x = 26, y = 2.0, 
           label = "Assemblage (Grid 100)", 
           color = "#9cc21a", 
           size = 5, fontface="bold")

# plotting in two axis

df_left  <- res_all_assemblage_richness2 |> 
  filter(group != "Clade Regional")

df_right <- res_all_assemblage_richness2 |> 
  filter(group == "Clade Regional")

# scaling axis 

range_left  <- range(df_left$n.species, na.rm = TRUE)
range_right <- range(df_right$n.species, na.rm = TRUE)

a <- diff(range_left)  / diff(range_right)
b <- range_left[1] - a * range_right[1]

df_right$n.species_scaled <- a * df_right$n.species + b

# plotting

p <- ggplot() +
  geom_smooth(
    data = df_left,
    aes(x = as.numeric(time.slice), y = n.species, color = group),
    method = "loess", se = TRUE, span = 0.75, alpha = 0.2, linewidth = 3
  ) +
  geom_line(
    data = df_right,
    aes(x = as.numeric(time.slice), y = n.species_scaled, color = group),
    linewidth = 1
  ) +
  scale_x_reverse(name = "Time (Ma)") +
  scale_y_continuous(
    name = "Assemblage richness",
    sec.axis = sec_axis(~ (. - b) / a, name = "Clade regional richness")
  ) +
  scale_color_manual(values = c(
    "Assemblage (Site)" = "#9fb493",
    "Assemblage (Grid 100)" = "#9cc21a",
    "Clade Regional" = "#b45f06"
  )) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    legend.position = "none",
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"),
    axis.title.x = element_text(size = 26),
    axis.title.y = element_text(size = 26),
    axis.text.x = element_text(size = 26),
    axis.text.y = element_text(size = 26)
  )


ggsave(here::here("inst", "extdata", "figures_canidae", "plot_all_local_richness.png"),
       p, 
       width = 10, 
       height = 10, 
       dpi = 800,
       bg = "white")

ggsave(here::here("inst", "extdata", "figures_canidae", "plot_all_local_richness.png"),
       all_plots_assemblage_richness, 
       width = 10, 
       height = 10, 
       dpi = 800,
       bg = "white")

```

Regional and mnnd grid with all points and smoothspline

```{r}
plots_grid100_smooth_raw_mnnd <- 
  ggplot(res_local_dist2_mnnd, 
         aes(x = as.numeric(time.slice), 
             y = mean.distance, 
             color = group)
  ) +
  geom_point(
    data = ~ subset(.x, group == "Assemblage (Grid 100)"),
    size = 2,
    alpha = 0.1
  ) +
  geom_smooth(
    data = ~ subset(.x, group == "Assemblage (Grid 100)"),
    se = TRUE,
    method = "loess",
    span = 0.75,
    alpha = 0.5,
    linewidth = 3
  ) +
  geom_line(
    data = ~ subset(.x, group == "Clade Regional"),
    linewidth = 1
  ) +
  scale_x_reverse() +
  scale_y_continuous(breaks = pretty(res_local_dist2_mnnd$mean.distance, n = 10)) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    legend.position = "none",
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"), 
    axis.text.x = element_text(size = 26), 
    axis.text.y = element_text(size = 26), 
    axis.title.x = element_text(size = 26),
    axis.title.y = element_text(size = 26)
  ) +
  scale_color_manual(values = c(
    "Clade Regional" = "#E41A1C", 
    "Assemblage (Grid 100)" = "#9cc21a"
  )) + 
  labs(x = "Time (Ma)", y = "Mean Nearest Neighbor Distance")


ggsave(here::here("inst", "extdata", "figures_canidae", "plot_grid100_raw_mnnd.png"),
       plots_grid100_smooth_raw_mnnd, 
       width = 10, 
       height = 10, 
       dpi = 800,
       bg = "white")

  
```

